<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lion OS ‚Äî Minimal Dark (Store + Terminal)</title>
<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1418;
  --card:#0c1114;
  --muted:#9aa6b2;
  --accent:#4aa3ff;
  --accent-weak:rgba(74,163,255,0.12);
  --glass: rgba(255,255,255,0.02);
  --round:18px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, 'Segoe UI', Roboto, system-ui, -apple-system, Arial;color:#eaf2ff;background:var(--bg);overflow:hidden}

/* SPLASH (transparent overlay so desktop visible) */
#splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:transparent;z-index:9999;transition:opacity .45s ease,visibility .45s}
#splash.hidden{opacity:0;visibility:hidden}
.splashLogo{font-weight:700;font-size:28px;margin-bottom:6px}
.splashSub{color:var(--muted);font-size:13px;margin-bottom:12px}
.splashProgress{width:380px;max-width:80%;height:8px;background:var(--glass);border-radius:8px;margin-top:6px;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,0.5)}
.splashProgress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#7fefff);border-radius:8px;transition:width .18s linear}

/* DESKTOP */
#desktop{position:fixed;inset:0;display:block;background-size:cover;background-position:center;transition:background .24s linear}

/* desktop icons - free positioning */
.desktopIcon{position:absolute;width:96px;text-align:center;color:#eaf2ff;cursor:grab;user-select:none;transition:transform .12s ease}
.desktopIcon:active{cursor:grabbing}
.desktopIcon img{width:64px;height:64px;border-radius:12px;display:block;margin:0 auto 6px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.7))}
.iconLabel{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* TASKBAR */
#taskbar{position:fixed;left:0;right:0;bottom:18px;height:60px;display:flex;align-items:center;justify-content:center;pointer-events:none}
#taskbarInner{width:760px;max-width:92%;height:60px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border-radius:14px;display:flex;align-items:center;gap:12px;padding:6px 14px;box-shadow:0 8px 30px rgba(0,0,0,0.6);pointer-events:auto}
.tb-btn{width:46px;height:46px;border-radius:10px;background:transparent;border:none;color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:transform .12s ease, background .12s}
.tb-btn:hover{transform:translateY(-3px);background:var(--accent-weak)}
.start-square{display:grid;grid-template-columns:repeat(2,10px);grid-gap:4px}
.start-square span{width:10px;height:10px;border-radius:2px;background:var(--accent)}

/* Windows */
.window{position:absolute;width:640px;max-width:92%;height:440px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:var(--round);border:1px solid rgba(255,255,255,0.03);box-shadow:0 24px 60px rgba(2,6,12,0.6);overflow:hidden;display:none;color:#eaf2ff}
.win-head{height:56px;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:transparent}
.win-title{font-weight:600}
.win-actions{display:flex;gap:8px}
.win-actions button{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px}
.win-body{padding:12px;height:calc(100% - 56px);overflow:auto;background:transparent;color:#cfe6ff}

/* STORE STYLES */
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.store-card{background:rgba(255,255,255,0.01);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;align-items:center}
.store-card img{width:64px;height:64px;border-radius:12px}
.install-btn{background:linear-gradient(90deg,var(--accent),#76d0ff);border:none;padding:8px 10px;border-radius:10px;color:#071322;cursor:pointer;font-weight:600}
.installting-bar{width:100%;height:8px;background:#0b0f12;border-radius:8px;overflow:hidden;display:none}
.installting-bar .fill{height:100%;width:0;background:linear-gradient(90deg,#6ae0ff,#4aa3ff);transition:width .12s linear}

/* TERMINAL */
.terminal{background:#061013;border-radius:8px;padding:12px;font-family:monospace;color:#9fffcf;height:100%;display:flex;flex-direction:column}
#termOutput{flex:1;overflow:auto;padding:6px;border-radius:6px;background:#021211;color:#9fffcf;font-size:13px}
#termInputRow{display:flex;gap:8px;margin-top:8px}
#termInput{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#bfffd6}
.cursor{display:inline-block;width:8px;height:16px;background:#9fffcf;margin-left:6px;animation:blink .9s step-end infinite;border-radius:2px}
@keyframes blink{50%{opacity:0}}

/* alerts */
#systemAlert{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:10px;background:#0a1a2a;color:#eaf2ff;opacity:0;transform:translateY(10px);transition:all .28s}
#systemAlert.show{opacity:1;transform:translateY(0)}

@media(max-width:720px){#taskbarInner{width:94%}}
</style>
</head>
<body>

<!-- SPLASH (transparent overlay) -->
<div id="splash" aria-hidden="false">
  <div style="text-align:center;pointer-events:none">
    <div class="splashLogo">Lion OS</div>
    <div class="splashSub">–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –º–∞–≥–∞–∑–∏–Ω –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª –≤–Ω—É—Ç—Ä–∏</div>
    <div class="splashProgress"><i id="splashFill"></i></div>
  </div>
</div>

<!-- DESKTOP (visible immediately) -->
<div id="desktop" role="application" aria-label="–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª"></div>

<!-- TASKBAR -->
<div id="taskbar" aria-hidden="false">
  <div id="taskbarInner" role="toolbar" aria-label="–ü–∞–Ω–µ–ª—å –∑–∞–¥–∞—á">
    <button id="startBtn" class="tb-btn" title="–ü—É—Å–∫" aria-label="–ü—É—Å–∫">
      <div class="start-square" aria-hidden="true"><span></span><span></span><span></span><span></span></div>
    </button>
    <div style="flex:1"></div>
    <button id="chatBtn" class="tb-btn" title="ChatBot" aria-label="Chat">üí¨</button>
    <button id="storeBtn" class="tb-btn" title="–ú–∞–≥–∞–∑–∏–Ω" aria-label="Store">üè¨</button>
    <button id="termBtn" class="tb-btn" title="–¢–µ—Ä–º–∏–Ω–∞–ª" aria-label="Terminal">‚å®Ô∏è</button>
    <button id="wallBtn" class="tb-btn" title="–û–±–æ–∏" aria-label="–û–±–æ–∏">üñºÔ∏è</button>
  </div>
</div>

<!-- WINDOWS (hidden initially) -->
<!-- Chat -->
<div id="chatWin" class="window" role="dialog" aria-hidden="true">
  <div class="win-head"><div class="win-title">ChatBot</div><div class="win-actions"><button id="chatGear">‚öôÔ∏è</button><button class="closeWin" data-target="chatWin">‚úï</button></div></div>
  <div class="win-body">
    <div class="muted">OpenAI API (—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ)</div>
    <input id="apiKey" type="text" placeholder="sk-...">
    <div style="display:flex;gap:8px;margin-top:8px"><button id="saveApi" class="install-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="clearApi" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted)">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.02)">
    <textarea id="chatInput" rows="3" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="sendBtn" class="install-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><button id="demoBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted)">–î–µ–º–æ</button></div>
    <div id="chatOut" style="margin-top:12px;background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;height:180px;overflow:auto"></div>
  </div>
</div>

<!-- Store -->
<div id="storeWin" class="window" role="dialog" aria-hidden="true">
  <div class="win-head"><div class="win-title">–ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</div><div class="win-actions"><button class="closeWin" data-target="storeWin">‚úï</button></div></div>
  <div class="win-body">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="searchApp" type="text" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf2ff">
      <button id="refreshStore" class="install-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div class="store-grid" id="storeGrid" aria-live="polite"></div>
  </div>
</div>

<!-- Terminal -->
<div id="termWin" class="window" role="dialog" aria-hidden="true">
  <div class="win-head"><div class="win-title">–¢–µ—Ä–º–∏–Ω–∞–ª</div><div class="win-actions"><button class="closeWin" data-target="termWin">‚úï</button></div></div>
  <div class="win-body">
    <div class="terminal">
      <div id="termOutput" aria-live="polite"></div>
      <div id="termInputRow">
        <input id="termInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (help –¥–ª—è —Å–ø–∏—Å–∫–∞)" autocomplete="off">
        <div class="cursor" aria-hidden="true"></div>
      </div>
    </div>
  </div>
</div>

<!-- Wallpapers window -->
<div id="wallWin" class="window" role="dialog" aria-hidden="true">
  <div class="win-head"><div class="win-title">–û–±–æ–∏</div><div class="win-actions"><button class="closeWin" data-target="wallWin">‚úï</button></div></div>
  <div class="win-body">
    <div class="muted">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
    <input id="wallInput" type="text" placeholder="https://...">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="applyWall" class="install-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button id="clearWall" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted)">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    <div style="margin-top:12px;color:var(--muted)">–ü—Ä–µ—Å–µ—Ç—ã:</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <img class="preset" src="https://raw.githubusercontent.com/solstice23/windows-11-wallpapers/main/Dark/img19.jpg" data-src="https://raw.githubusercontent.com/solstice23/windows-11-wallpapers/main/Dark/img19.jpg" style="width:120px;height:70px;object-fit:cover;border-radius:10px;cursor:pointer">
      <img class="preset" src="https://images.unsplash.com/photo-1503264116251-35a269479413?w=1200&q=80" data-src="https://images.unsplash.com/photo-1503264116251-35a269479413?w=1200&q=80" style="width:120px;height:70px;object-fit:cover;border-radius:10px;cursor:pointer">
    </div>
  </div>
</div>

<div id="systemAlert" role="status" aria-live="polite"></div>

<script>
/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
function showAlert(text, isErr=false){
  const s = $('systemAlert');
  s.textContent = text;
  s.style.background = isErr ? '#3a1313' : '#0a1a2a';
  s.classList.add('show');
  s.style.opacity='1'; s.style.transform='translateY(0)';
  setTimeout(()=>{ s.style.opacity='0'; s.style.transform='translateY(10px)'; }, 3000);
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- Splash progress (auto 3s) ---------- */
(function(){
  const f = $('splashFill');
  let p = 0;
  const totalMs = 3000;
  const stepMs = 30;
  const inc = 100 / (totalMs / stepMs);
  const iv = setInterval(()=>{
    p = Math.min(100, p + inc);
    f.style.width = p + '%';
    if(p >= 100){ clearInterval(iv); setTimeout(()=>{ $('splash').classList.add('hidden'); setTimeout(()=>{$('splash').style.display='none'; },420); },300); }
  }, stepMs);
})();

/* ---------- Windows open/close/drag ---------- */
let _z = 100;
function openWindow(id){
  const el = $(id);
  if(!el) return;
  if(el.style.display !== 'block'){
    el.style.left = (window.innerWidth - el.offsetWidth)/2 + 'px';
    el.style.top = (window.innerHeight - el.offsetHeight)/2 + 'px';
  }
  el.style.display = 'block';
  el.setAttribute('aria-hidden','false');
  el.style.zIndex = ++_z;
}
document.querySelectorAll('.closeWin').forEach(b=>{
  b.addEventListener('click', e=>{
    const t = e.currentTarget.dataset.target;
    if($(t)){ $(t).style.display='none'; $(t).setAttribute('aria-hidden','true'); }
  });
});
document.querySelectorAll('.window').forEach(win=>{
  const head = win.querySelector('.win-head');
  head && head.addEventListener('mousedown', e=>{
    win.style.zIndex = ++_z;
    const rect = win.getBoundingClientRect();
    const shiftX = e.clientX - rect.left;
    const shiftY = e.clientY - rect.top;
    function onMove(ev){ win.style.left = Math.max(8, Math.min(window.innerWidth - rect.width - 8, ev.clientX - shiftX)) + 'px'; win.style.top  = Math.max(8, Math.min(window.innerHeight - rect.height - 8, ev.clientY - shiftY)) + 'px'; }
    function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
});

/* ---------- Taskbar buttons ---------- */
$('chatBtn').addEventListener('click', ()=> openWindow('chatWin'));
$('storeBtn').addEventListener('click', ()=> openWindow('storeWin'));
$('termBtn').addEventListener('click', ()=> openWindow('termWin'));
$('wallBtn').addEventListener('click', ()=> openWindow('wallWin'));

/* ---------- Chat (same as before) ---------- */
$('saveApi').addEventListener('click', ()=>{
  const v = $('apiKey').value.trim();
  if(!v){ showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á', true); return; }
  fetch('https://api.openai.com/v1/models', { headers:{ 'Authorization':'Bearer ' + v } })
    .then(r=>{ if(r.ok){ localStorage.setItem('lion_api', v); showAlert('API —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); } else showAlert('–û—à–∏–±–∫–∞ API', true); })
    .catch(()=> showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ', true));
});
$('clearApi').addEventListener('click', ()=>{ localStorage.removeItem('lion_api'); $('apiKey').value=''; showAlert('API —É–¥–∞–ª—ë–Ω'); });
$('sendBtn').addEventListener('click', sendMessage);
$('demoBtn').addEventListener('click', ()=>{ const out=$('chatOut'); out.innerHTML += `<div style="color:var(--muted)">–î–µ–º–æ-–æ—Ç–≤–µ—Ç: —Å–∏—Å—Ç–µ–º–∞ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ.</div>`; out.scrollTop = out.scrollHeight; });

function sendMessage(){
  const txt = $('chatInput').value.trim(); if(!txt) return;
  const out = $('chatOut'); out.innerHTML += `<div style="margin:6px 0"><b>–í—ã:</b> ${escapeHtml(txt)}</div>`; $('chatInput').value='';
  const q = txt.toLowerCase();
  if(q.includes('lion os') || q.includes('—Ä–∞—Å—Å–∫–∞–∂–∏')){ out.innerHTML += `<div style="margin:6px 0"><b>ChatGPT:</b> Lion OS ‚Äî –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç—ë–º–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞.</div>`; out.scrollTop = out.scrollHeight; return; }
  const key = localStorage.getItem('lion_api');
  if(!key){ setTimeout(()=>{ out.innerHTML += `<div style="margin:6px 0"><b>ChatGPT:</b> (–î–µ–º–æ) ${escapeHtml(txt)}</div>`; out.scrollTop = out.scrollHeight; }, 350); return; }
  fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer ' + key }, body: JSON.stringify({ model:'gpt-3.5-turbo', messages:[{role:'user', content:txt}], max_tokens:300 }) })
    .then(r=>r.json()).then(d=>{ try{ const rep = d.choices[0].message.content; out.innerHTML += `<div style="margin:6px 0"><b>ChatGPT:</b> ${escapeHtml(rep)}</div>`; out.scrollTop = out.scrollHeight; }catch(e){ out.innerHTML += `<div style="color:#f88">–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞</div>`; } })
    .catch(()=> out.innerHTML += `<div style="color:#f88">–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞</div>`);
}

/* ---------- Wallpapers ---------- */
$('applyWall').addEventListener('click', ()=>{ const url = $('wallInput').value.trim(); if(!url){ showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É', true); return; } if(!/^https?:\/\//i.test(url)){ showAlert('–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å http(s)', true); return; } const img = new Image(); img.onload = ()=>{ document.getElementById('desktop').style.backgroundImage = `url('${url}')`; document.getElementById('desktop').style.backgroundSize = 'cover'; document.getElementById('desktop').style.backgroundPosition='center'; localStorage.setItem('lion_wall', url); showAlert('–§–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω'); }; img.onerror = ()=> showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', true); });
$('clearWall').addEventListener('click', ()=>{ document.getElementById('desktop').style.backgroundImage=''; localStorage.removeItem('lion_wall'); showAlert('–§–æ–Ω —Å–±—Ä–æ—à–µ–Ω'); });
document.querySelectorAll('.preset').forEach(p=> p.addEventListener('click', e=>{ const url = e.currentTarget.dataset.src; document.getElementById('desktop').style.backgroundImage = `url('${url}')`; localStorage.setItem('lion_wall', url); showAlert('–§–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω'); }));

function restoreWallpaper(){ const w = localStorage.getItem('lion_wall'); if(w) document.getElementById('desktop').style.backgroundImage = `url('${w}')`; }

/* ---------- Desktop icons: draggable + persistence + add-on-install ---------- */
function makeIcon(name, iconUrl, left=28, top=32){
  const desktop = $('desktop');
  const el = document.createElement('div');
  el.className = 'desktopIcon';
  el.style.left = left + 'px';
  el.style.top  = top  + 'px';
  el.innerHTML = `<img src="${iconUrl}" alt="${escapeHtml(name)}"><div class="iconLabel">${escapeHtml(name)}</div>`;
  desktop.appendChild(el);

  // drag
  let dragging=false, sx=0, sy=0, ox=0, oy=0;
  el.addEventListener('mousedown', e=>{
    dragging=true; el.style.cursor='grabbing'; sx=e.clientX; sy=e.clientY; ox=parseInt(el.style.left); oy=parseInt(el.style.top); el.style.transform='scale(1.02)'; el.style.zIndex = ++_z;
  });
  document.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX - sx; const dy=e.clientY - sy; el.style.left = Math.max(8, Math.min(window.innerWidth - 100, ox + dx)) + 'px'; el.style.top = Math.max(8, Math.min(window.innerHeight - 140, oy + dy)) + 'px'; });
  document.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; el.style.cursor='grab'; el.style.transform='scale(1)'; saveIcons(); } });

  // double-click opens demo or real app if installed name matches small set
  el.addEventListener('dblclick', ()=>{
    const nm = el.querySelector('.iconLabel').textContent.toLowerCase();
    if(nm.includes('browser')) openAppBrowser();
    else if(nm.includes('chat')) openWindow('chatWin');
    else if(nm.includes('terminal')) openWindow('termWin');
    else showAlert('–ó–∞–ø—É—Å–∫: ' + nm);
  });
}

function saveIcons(){
  const nodes = Array.from(document.querySelectorAll('.desktopIcon'));
  const data = nodes.map(n=>({ name: n.querySelector('.iconLabel').textContent, icon: n.querySelector('img').src, left: parseInt(n.style.left), top: parseInt(n.style.top) }));
  localStorage.setItem('lion_icons_pos', JSON.stringify(data));
}
function restoreIconPositions(){
  const raw = localStorage.getItem('lion_icons_pos');
  if(!raw){
    makeIcon('Lion Browser','https://cdn-icons-png.flaticon.com/512/482/482631.png',28,32);
    makeIcon('ChatBot','https://cdn-icons-png.flaticon.com/512/4712/4712021.png',28,132);
    return;
  }
  try{
    const arr = JSON.parse(raw);
    arr.forEach(it=> makeIcon(it.name,it.icon,it.left,it.top));
  }catch(e){}
}

/* ---------- Store data & UI (modern tiles, search, 1-click install, progress) ---------- */
const STORE_APPS = [
  { id:'lion-browser', title:'Lion Browser', desc:'–ë—ã—Å—Ç—Ä—ã–π –±—Ä–∞—É–∑–µ—Ä', icon:'https://cdn-icons-png.flaticon.com/512/482/482631.png' },
  { id:'term-plus', title:'Terminal Plus', desc:'–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª', icon:'https://img.icons8.com/ios-filled/100/ffffff/console.png' },
  { id:'notepad', title:'–ë–ª–æ–∫–Ω–æ—Ç', desc:'–ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä', icon:'https://img.icons8.com/ios-filled/100/ffffff/note.png' },
  { id:'files', title:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫', desc:'–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', icon:'https://img.icons8.com/ios-filled/100/ffffff/folder-invoices.png' }
];

function renderStore(filter=''){
  const grid = $('storeGrid'); grid.innerHTML = '';
  const lower = (filter||'').toLowerCase();
  STORE_APPS.filter(a => a.title.toLowerCase().includes(lower) || a.desc.toLowerCase().includes(lower)).forEach(app=>{
    const card = document.createElement('div'); card.className='store-card';
    card.innerHTML = `<img src="${app.icon}" alt="${escapeHtml(app.title)}"><div style="font-weight:600">${escapeHtml(app.title)}</div><div style="font-size:13px;color:var(--muted);text-align:center">${escapeHtml(app.desc)}</div><div style="width:100%;display:flex;gap:8px;margin-top:8px"><button class="install-btn" data-id="${app.id}">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button></div><div class="installting-bar" id="prog-${app.id}"><div class="fill"></div></div>`;
    grid.appendChild(card);
  });
  // wire install buttons
  grid.querySelectorAll('.install-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id;
      startInstall(id);
    });
  });
}

/* start install with visual progress and add icon on finish (no sound) */
function startInstall(appId){
  const barWrap = $('prog-'+appId);
  if(!barWrap) return;
  const fill = barWrap.querySelector('.fill');
  barWrap.style.display = 'block';
  let p = 0;
  const t = setInterval(()=>{
    p += Math.floor(6 + Math.random()*8);
    fill.style.width = Math.min(100,p) + '%';
    if(p >= 100){
      clearInterval(t);
      setTimeout(()=>{ barWrap.style.display='none'; fill.style.width='0%'; markInstalled(appId); }, 250);
    }
  }, 180);
}

/* mark app installed in localStorage and add desktop icon */
function markInstalled(appId){
  // add to installed list
  const inst = JSON.parse(localStorage.getItem('lion_installed')||'[]');
  if(!inst.includes(appId)) inst.push(appId);
  localStorage.setItem('lion_installed', JSON.stringify(inst));
  // add desktop icon (map id->meta)
  const meta = STORE_APPS.find(a => a.id === appId);
  if(meta){
    // pick a default position (avoid overlap)
    const pos = findFreePosition();
    makeIcon(meta.title, meta.icon, pos.left, pos.top);
    saveIcons();
    showAlert(meta.title + ' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  } else {
    showAlert('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ' + appId);
  }
}

/* find free position on desktop for new icon */
function findFreePosition(){
  const baseLeft = 28, baseTop = 32;
  const stepY = 110;
  const icons = document.querySelectorAll('.desktopIcon');
  const used = Array.from(icons).map(el=>({left:parseInt(el.style.left), top:parseInt(el.style.top)}));
  for(let row=0; row<8; row++){
    const y = baseTop + row*stepY;
    let found = false;
    for(let col=0; col<6; col++){
      const x = baseLeft + col*110;
      if(!used.some(u=>Math.abs(u.left - x) < 10 && Math.abs(u.top - y) < 10)) return {left:x, top:y};
    }
  }
  return {left:baseLeft, top:baseTop};
}

/* store search */
$('searchApp')?.addEventListener('input', e=> renderStore(e.target.value.trim()));
$('refreshStore')?.addEventListener('click', ()=> renderStore(''));

/* ---------- Terminal (modern) ---------- */
const termOut = $('termOutput'), termIn = $('termInput');
function termPrint(html){ termOut.innerHTML += html + '<br>'; termOut.scrollTop = termOut.scrollHeight; }
function termClear(){ termOut.innerHTML = ''; }
function termSystemInfo(){
  return `Lion OS ‚Äî –¥–µ–º–æ —Å–∏—Å—Ç–µ–º–∞<br>–í—Ä–µ–º—è: ${new Date().toLocaleString()}<br>–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π: ${(JSON.parse(localStorage.getItem('lion_installed')||'[]')).length}`;
}
function handleCommand(line){
  const cmd = (line||'').trim();
  if(!cmd) return;
  const parts = cmd.split(' ');
  const c = parts[0].toLowerCase();
  if(c === 'help'){
    termPrint('<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b> help, clear, echo, apps, open &lt;app&gt;, wallpaper &lt;url&gt;, system');
  } else if(c === 'clear'){
    termClear();
  } else if(c === 'echo'){
    termPrint(escapeHtml(parts.slice(1).join(' ')));
  } else if(c === 'apps'){
    const inst = JSON.parse(localStorage.getItem('lion_installed')||'[]');
    termPrint('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + (inst.length?inst.join(', '):'–Ω–µ—Ç'));
  } else if(c === 'open'){
    const name = parts.slice(1).join(' ').toLowerCase();
    if(!name) { termPrint('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–∏–º–µ—Ä: open Lion Browser'); return; }
    // try match by title or id
    const byTitle = STORE_APPS.find(a=>a.title.toLowerCase() === name);
    const byId = STORE_APPS.find(a=>a.id === name);
    if(byTitle || byId){
      const target = (byTitle||byId).id;
      // open corresponding window if it's terminal or chat or browser installed
      if(target === 'lion-browser') openAppBrowser();
      else if(target === 'term-plus') openWindow('termWin');
      else if(target === 'notepad') openAppNotepad();
      else if(target === 'files') openAppFiles();
      termPrint('–û—Ç–∫—Ä—ã—Ç–æ: ' + (byTitle||byId).title);
    } else {
      // also try desktop icons by name
      const icons = Array.from(document.querySelectorAll('.desktopIcon .iconLabel')).map(n=>n.textContent.toLowerCase());
      if(icons.some(t=>t === name)){
        termPrint('–û—Ç–∫—Ä—ã—Ç–æ: ' + name);
      } else {
        termPrint('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: ' + escapeHtml(name));
      }
    }
  } else if(c === 'wallpaper'){
    const url = parts.slice(1).join(' ');
    if(!url) { termPrint('–£–∫–∞–∂–∏—Ç–µ URL: wallpaper https://...'); return; }
    // apply
    const img = new Image();
    img.onload = ()=>{ document.getElementById('desktop').style.backgroundImage = `url('${url}')`; localStorage.setItem('lion_wall', url); termPrint('–§–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω'); };
    img.onerror = ()=> termPrint('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  } else if(c === 'system'){
    termPrint(termSystemInfo());
  } else {
    termPrint('–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ' + escapeHtml(c));
  }
}

termIn.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){ handleCommand(termIn.value); termIn.value=''; }
});

/* ---------- small helpers to open apps from terminal/desktop ---------- */
function openAppNotepad(){ openWindow('notepadWin'); createNotepadIfNeeded(); }
function openAppFiles(){ openWindow('filesWin'); createFilesIfNeeded(); }
function openAppBrowser(){ openWindow('browserWin'); createBrowserIfNeeded(); }

/* create auxiliary windows (not persistent across reload besides icons) */
function createNotepadIfNeeded(){
  if($('notepadWin')) return;
  const el = document.createElement('div'); el.className='window'; el.id='notepadWin';
  el.innerHTML = `<div class="win-head"><div class="win-title">–ë–ª–æ–∫–Ω–æ—Ç</div><div class="win-actions"><button class="closeWin" data-target="notepadWin">‚úï</button></div></div><div class="win-body"><textarea style="width:100%;height:320px;background:transparent;color:#eaf2ff;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03)"></textarea></div>`;
  document.body.appendChild(el);
  // wire close and drag
  el.querySelector('.closeWin').addEventListener('click', ()=> el.remove());
  makeDraggable(el);
  openWindow('notepadWin');
}

function createFilesIfNeeded(){
  if($('filesWin')) return;
  const el = document.createElement('div'); el.className='window'; el.id='filesWin';
  el.innerHTML = `<div class="win-head"><div class="win-title">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</div><div class="win-actions"><button class="closeWin" data-target="filesWin">‚úï</button></div></div><div class="win-body"><div style="color:var(--muted)">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ (–¥–µ–º–æ)</div></div>`;
  document.body.appendChild(el);
  el.querySelector('.closeWin').addEventListener('click', ()=> el.remove());
  makeDraggable(el);
  openWindow('filesWin');
}

function createBrowserIfNeeded(){
  if($('browserWin')) return;
  const el = document.createElement('div'); el.className='window'; el.id='browserWin';
  el.innerHTML = `<div class="win-head"><div class="win-title">Lion Browser</div><div class="win-actions"><button class="closeWin" data-target="browserWin">‚úï</button></div></div><div class="win-body"><div style="display:flex;gap:8px;margin-bottom:8px"><input id="urlInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∑–∞–ø—Ä–æ—Å" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#eaf2ff"><button id="openUrlBtn" class="install-btn">–û—Ç–∫—Ä—ã—Ç—å</button></div><div style="height:320px;background:#071017;border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)">–°–∞–π—Ç—ã –±—É–¥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º CORS.<br><small>–í–≤–µ–¥–∏—Ç–µ URL –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–∫—Ä—ã—Ç—å</small></div></div>`;
  document.body.appendChild(el);
  el.querySelector('.closeWin').addEventListener('click', ()=> el.remove());
  makeDraggable(el);
  openWindow('browserWin');
  setTimeout(()=>{ const btn = $('openUrlBtn'); btn && btn.addEventListener('click', ()=>{ const v = $('urlInput').value.trim(); if(!v) return; let url = v; if(!/^https?:\/\//i.test(url)) url = 'https://www.google.com/search?q='+encodeURIComponent(v); window.open(url, '_blank'); addHistory(v); showAlert('–û—Ç–∫—Ä—ã—Ç–æ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ'); }); },50);
}

/* make element draggable helper (for created windows) */
function makeDraggable(win){
  const head = win.querySelector('.win-head');
  head && head.addEventListener('mousedown', e=>{
    win.style.zIndex = ++_z;
    const rect = win.getBoundingClientRect();
    const shiftX = e.clientX - rect.left; const shiftY = e.clientY - rect.top;
    function onMove(ev){ win.style.left = Math.max(8, Math.min(window.innerWidth - rect.width - 8, ev.clientX - shiftX)) + 'px'; win.style.top  = Math.max(8, Math.min(window.innerHeight - rect.height - 8, ev.clientY - shiftY)) + 'px'; }
    function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

/* Browser history helper (local) */
function addHistory(u){ try{ const raw = localStorage.getItem('lion_browser_history')||'[]'; const arr = JSON.parse(raw); arr.push(u); localStorage.setItem('lion_browser_history', JSON.stringify(arr.slice(-200))); }catch(e){} }

/* ---------- Initialization ---------- */
window.addEventListener('load', ()=>{
  // restore wallpaper
  restoreWallpaper();
  // restore icons
  setTimeout(()=> restoreIconPositions(), 120);
  // render store
  renderStore('');
  // wire store search
  const s = $('searchApp'); if(s) s.addEventListener('input', e=> renderStore(e.target.value));
  // wire window openers from pinned/desktop if any
  // set saved API into chat
  const savedKey = localStorage.getItem('lion_api'); if(savedKey) $('apiKey').value = savedKey;
  // populate installed icons for apps in installed list (in case user installed previously but icons lost)
  const installed = JSON.parse(localStorage.getItem('lion_installed')||'[]');
  if(installed.length){
    // ensure desktop has icons for installed (but avoid duplicates)
    const existing = Array.from(document.querySelectorAll('.desktopIcon .iconLabel')).map(n=>n.textContent);
    installed.forEach(id=>{
      const meta = STORE_APPS.find(a=>a.id===id);
      if(meta && !existing.includes(meta.title)){
        const pos = findFreePosition();
        makeIcon(meta.title, meta.icon, pos.left, pos.top);
      }
    });
    saveIcons();
  }
  // terminal welcome
  setTimeout(()=>{ termPrint('Lion Terminal ‚Äî –≤–≤–µ–¥–∏—Ç–µ help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥'); }, 400);
});

/* ---------- small UI: start menu (toggle) ---------- */
const startBtn = $('startBtn');
let startMenuEl = null;
startBtn.addEventListener('click', ()=>{
  if(!startMenuEl){
    startMenuEl = document.createElement('div');
    startMenuEl.id = 'startMenu';
    startMenuEl.innerHTML = `<div class="startItem" onclick="openAppNotepad()">üìù –ë–ª–æ–∫–Ω–æ—Ç</div><div class="startItem" onclick="openAppBrowser()">üåê Lion Browser</div><div class="startItem" onclick="openAppFiles()">üìÅ –ü—Ä–æ–≤–æ–¥–Ω–∏–∫</div><div class="startItem" onclick="openWindow('storeWin')">üè¨ –ú–∞–≥–∞–∑–∏–Ω</div><div class="startItem" onclick="openWindow('termWin')">‚å®Ô∏è –¢–µ—Ä–º–∏–Ω–∞–ª</div><div class="startItem" onclick="openWindow('wallWin')">üñºÔ∏è –û–±–æ–∏</div><div class="startItem" onclick="location.reload()">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞</div>`;
    document.body.appendChild(startMenuEl);
  }
  startMenuEl.style.display = startMenuEl.style.display === 'block' ? 'none' : 'block';
});

/* close start menu on click outside */
document.addEventListener('click', e=>{
  if(startMenuEl && !startMenuEl.contains(e.target) && e.target !== startBtn) startMenuEl.style.display = 'none';
});

/* ---------- Utilities for terminal printing ---------- */
function termPrint(html){ termOut.innerHTML += html + '<br>'; termOut.scrollTop = termOut.scrollHeight; }

/* ---------- Expose some functions to global to be used in inline onclicks if needed ---------- */
window.openAppBrowser = openAppBrowser;
window.openAppNotepad = openAppNotepad;
window.openAppFiles = openAppFiles;
window.makeIcon = makeIcon;

</script>
</body>
</html>